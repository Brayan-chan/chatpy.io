<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <title>chatpy.io</title>
  <link rel="stylesheet" href="../static/css/styles.css">
  <link href="https://unpkg.com/filepond/dist/filepond.css" rel="stylesheet">
  <link href="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.css" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="../static/images/favicon.ico" />
  <link rel="icon" type="image/png" sizes="16x16" href="../static/images/favicon.png" />
  <script src="https://unpkg.com/filepond-plugin-file-encode/dist/filepond-plugin-file-encode.js"></script>
  <script
    src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script>
  <script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
  <script src="https://unpkg.com/filepond/dist/filepond.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1259.0.min.js"></script>
  <!-- CSS de Fancybox -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- JS de Fancybox -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

  <!-- CSS de Plyr -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <!-- JS de Plyr -->
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <style>
    /* Estilos para dispositivos móviles */
    @media (max-width: 768px) {
      .chat-container {
        grid-template-columns: 1fr !important;
      }

      .nav-sidebar {
        display: none;
      }

      .chat-sidebar {
        position: fixed;
        left: -100%;
        top: 0;
        bottom: 0;
        width: 100%;
        z-index: 40;
        transition: left 0.3s ease;
      }

      .chat-sidebar.active {
        left: 0;
      }

      .mobile-nav {
        display: flex !important;
      }

      #emoji-picker-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 50;
        display: none;
      }

      .message-input-container {
        position: relative;
        z-index: 1;
      }

      .fa-sign-out-alt {
        color: rgb(223, 19, 19);
      }

      .mobile {
        display: block !important;
      }
    }

    .mobile-nav {
      display: none;
      padding: 0.5rem;
    }

    .mobile-menu-button {
      background: none;
      border: none;
      color: #8f8f8f;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .videochat-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #056162;
      color: white;
      padding: 15px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }

    .videochat-notification button {
      background-color: #0a7373;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      color: white;
      font-weight: bold;
    }

    .videochat-notification button:hover {
      background-color: #056162;
    }
  </style>
</head>

<body>
  <div class="chat-container">
    <nav class="nav-sidebar">
      <div class="nav-top">
        <div class="nav-icon action-button">
          <i class="fas fa-comment"></i>
        </div>
        <div class="unread-total">6</div>
      </div>
      <div class="nav-bottom">
        <div class="dropdown">
          <div class="nav-icon action-button cursor-pointer" id="settings-button">
            <!-- Botón para cerrar la sesión -->
            <i class="fas fa-sign-out-alt"></i>
          </div>
          <div id="dropdown-menu" class="dropdown-menu">
            <a href="/logout">
              <i class="fas fa-sign-out-alt"></i>
              Cerrar sesión
            </a>
          </div>
        </div>
        <!-- Este div sirve para cargar y mostrar la imagen del usuario -->
        <div class="user-avatar">
          <a id="upload-avatar-link-nav" class="action-button" href="javascript:void(0);">
            <img id="user-avatar-img-nav" src="{{ user.profile_pic }}" alt="Tú">
          </a>
        </div>
      </div>
    </nav>

    <aside class="chat-sidebar">
      <div class="sidebar-header">
        <h1>Chats</h1>
        <div class="header-icons">
          <button class="action-button" id="add-contact-button">
            <i class="fas fa-user-plus"></i>
          </button>
          <button class="action-button" id="create-group-button">
            <i class="fas fa-users"></i>
          </button>
          <div class="user-avatar mobile hidden">
            <a id="upload-avatar-link-mobile" class="action-button" href="javascript:void(0);">
              <img id="user-avatar-img-mobile" src="{{ user.profile_pic }}" alt="Tú">
            </a>
          </div>
          <button class="action-button mobile-only-button mobile hidden" onclick="window.location.href='/logout'">
            <i class="fas fa-sign-out-alt"></i>
          </button>
          <button class="mobile-menu-button hidden md:hidden" id="close-sidebar-button">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>

      <div class="search-container">
        <i class="search-icon fas fa-search"></i>
        <input type="text" class="search-input" placeholder="Buscar">
      </div>

      <div class="filter-buttons">
        <button class="filter-button">Todos</button>
        <button class="filter-button">No leídos</button>
      </div>

      <div class="chat-list">
        <!-- Aquí se agregarán los items de chats (contactos y grupos) -->
      </div>
    </aside>

    <main class="chat-main">
      <header class="chat-header">
        <div class="header-left">
          <div class="mobile-nav">
            <button class="mobile-menu-button" id="mobile-menu-button">
              <i class="fas fa-bars"></i>
            </button>
          </div>
          <div class="avatar">
            <img id="chat-avatar" src="/placeholder.svg" alt="Chat">
          </div>
          <div>
            <h2 id="chat-title">Chats</h2>
            <div id="chat-subtitle" style="color: #8f8f8f"></div>
          </div>
        </div>
        <div class="header-right">
          <!-- Botón para el videochat-->
          <button onclick="startVideochat()" class="action-button">
            <i class="fas fa-video"></i>
          </button>
          <button class="action-button">
            <i class="fas fa-search"></i>
          </button>
          <button class="action-button" id="group-settings-button">
            <i class="fas fa-ellipsis-v"></i>
          </button>
        </div>
      </header>

      <div class="messages-container">
        <!-- Mensajes se cargarán aquí -->
      </div>

      <div id="file-upload-container"
        style="display: none; padding: 10px; background-color: #2a2a2a; border-top: 1px solid #333;">
        <input type="file" class="filepond" name="filepond" multiple>
        <div class="upload-controls">
          <button id="cancel-upload" class="action-button">Cancelar</button>
          <button id="send-files" class="action-button">Enviar</button>
        </div>
      </div>

      <div class="message-input-container">
        <button class="action-button" id="file-button">
          <i class="fas fa-paperclip"></i>
        </button>
        <button class="action-button" id="emoji-button">
          <i class="fas fa-smile"></i>
        </button>
        <div class="message-input-wrapper">
          <input type="text" class="message-input" id="message-input" placeholder="Escribe un mensaje">
        </div>
        <button class="action-button" id="send-button">
          <i class="fas fa-paper-plane"></i>
        </button>
        <button id="grabar-audio" class="action-button">
          <i class="fas fa-microphone"></i>
        </button>
      </div>

      <div id="emoji-picker-container">
        <emoji-picker></emoji-picker>
      </div>
    </main>
  </div>

  <div id="videochat-notification" class="videochat-notification" style="display: none;">
    <span>Videollamada entrante...</span>
    <button onclick="acceptVideochat()">Aceptar</button>
    <button onclick="rejectVideochat()" style="background-color: #b54040;">Rechazar</button>
  </div>

  <!-- Modal para agregar contactos -->
  <div id="add-contact-modal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Agregar Contacto</h2>
      <form id="add-contact-form">
        <input type="text" id="contact-username" placeholder="Nombre de usuario" required>
        <button id="add-contact-submit" type="submit">Agregar</button>
      </form>
    </div>
  </div>

  <!-- Modal para crear grupo -->
  <div id="create-group-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="close-group-modal">&times;</span>
      <h2>Crear Grupo</h2>
      <form id="create-group-form">
        <input type="text" id="group-name" placeholder="Nombre del grupo" required>
        <h3>Selecciona miembros</h3>
        <div id="group-members-list">
          <!-- Se cargarán los checkboxes de contactos -->
        </div>
        <h3>Selecciona administradores (opcional)</h3>
        <div id="group-admins-list">
          <!-- Se cargarán los checkboxes de contactos para admin -->
        </div>
        <button id="add-group-submit" type="submit">Crear Grupo</button>
      </form>
    </div>
  </div>

  <!-- Modal para actualizar avatar del grupo -->
  <div id="update-group-avatar-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="close-group-avatar-modal">&times;</span>
      <h2>Actualizar Avatar del Grupo</h2>
      <div class="avatar">
        <img id="group-avatar-img" src="/placeholder.svg" alt="Avatar del Grupo">
      </div>
      <button id="upload-group-avatar-button" class="action-button">Subir nueva imagen</button>
    </div>
  </div>

  <!-- Template para enviar mensajes -->
  <template id="message-template-sent">
    <div class="message sent">
      <p></p>
      <div class="message-time"></div>
    </div>
  </template>

  <!-- Template para recibir mensajes -->
  <template id="message-template-received">
    <div class="message-group">
      <div class="avatar">
        <img src="/placeholder.svg" alt="Avatar">
      </div>
      <div class="message received">
        <strong></strong>
        <p></p>
        <div class="message-time"></div>
      </div>
    </div>
  </template>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoomId = null;
    let notificationsEnabled = true;
    let s3; // Definir la variable s3
    let S3_BUCKET_NAME; // Definir la variable S3_BUCKET_NAME

    function playNotificationSound() {
      if (!notificationsEnabled) return; // No reproducir si las notificaciones están desactivadas

      const notificationSound = document.getElementById('notification-sound');
      notificationSound.currentTime = 0; // Reiniciar el sonido
      notificationSound.play().catch(error => {
        console.error('Error al reproducir el sonido de notificación:', error);
      });
    }

    socket.on('connect', () => {
      console.log('Connected to server');
    });

    socket.on('disconnect', () => {
      console.log('Disconnected from server');
    });

    socket.on('videochat_request', (data) => {
      currentRoomId = data.room_id;
      document.getElementById('videochat-notification').style.display = 'flex';
      playNotificationSound(); // Reproducir sonido de notificación
    });

    socket.on('videochat_start', (data) => {
      window.open(`/videochat?room_id=${data.room_id}`, '_blank');
    });

    function startVideochat() {
      if (currentChatUserId) {
        fetch('/start_videochat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ receiver_id: currentChatUserId })
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              console.log('Videollamada iniciada, room_id:', data.room_id);
              // Redirigir a la página de videochat con el room_id
              window.open(`/videochat?room_id=${data.room_id}`, '_blank');
            } else {
              console.error('Error al iniciar videollamada:', data.message);
            }
          })
          .catch(error => console.error('Error:', error));
      } else {
        console.error('No hay un chat seleccionado');
        alert('Selecciona un chat primero para iniciar una videollamada');
      }
    }

    function acceptVideochat() {
      if (currentRoomId) {
        fetch('/accept_videochat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ room_id: currentRoomId })
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              console.log('Videollamada aceptada');
              document.getElementById('videochat-notification').style.display = 'none';
              // Abrir en una nueva pestaña
              window.open(`/videochat?room_id=${currentRoomId}`, '_blank');
            } else {
              console.error('Error al aceptar videollamada:', data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }
    }

    function rejectVideochat() {
      document.getElementById('videochat-notification').style.display = 'none';
      currentRoomId = null;
    }

    // Variables de sesión y control de chat
    const sessionUserId = "{{ session['user_id'] }}";
    let currentChatUserId = null; // Puede ser id de contacto o de grupo
    let currentChatType = 'private'; // 'private' o 'group'

    const settingsButton = document.getElementById('settings-button');
    const dropdownMenu = document.getElementById('dropdown-menu');
    let isOpen = false;

    // Manejo del menú móvil
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const closeSidebarButton = document.getElementById('close-sidebar-button');
    const chatSidebar = document.querySelector('.chat-sidebar');

    mobileMenuButton.addEventListener('click', () => {
      chatSidebar.classList.add('active');
    });

    closeSidebarButton.addEventListener('click', () => {
      chatSidebar.classList.remove('active');
    });

    // Cerrar sidebar al hacer clic fuera en móvil
    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 768 &&
        !chatSidebar.contains(e.target) &&
        !mobileMenuButton.contains(e.target)) {
        chatSidebar.classList.remove('active');
      }
    });

    // Manejar cambios de tamaño de ventana
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        chatSidebar.classList.remove('active');
      }
    });

    // Enviar mensaje (según currentChatType)
    function messageSend() {
      const messageInput = document.getElementById('message-input');
      const message = messageInput.value;
      if (message.trim() !== '' && currentChatUserId) {
        const data = {
          sender: sessionUserId,
          receiver: currentChatUserId,
          type: currentChatType,
          message: message
        };
        socket.emit('send_message', data);
        messageInput.value = '';
      }
    };

    // Evento al hacer clic en el botón Enviar
    document.getElementById('send-button').addEventListener("click", messageSend);

    // Evento al presionar la tecla Enter en el campo de mensaje
    document.getElementById('message-input').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) { // Enter sin Shift
        e.preventDefault(); // Evita el salto de línea o el envío del formulario
        messageSend(); // Llama a la función para enviar el mensaje
      }
    });

    // Lista para almacenar los IDs de los mensajes ya procesados
    const processedMessageIds = new Set();

    // Manejo de nuevos mensajes: se muestran si corresponden al chat activo, y si no, se actualiza el badge
    socket.on('new_message', (data) => {
      const { sender, sender_id, receiver, message, type, audio_url, file_url, file_type, _id, sender_avatar } = data;

      // Determinar si el mensaje es enviado o recibido
      const isSentByMe = sender_id === sessionUserId;
      const msgType = isSentByMe ? 'sent' : 'received';

      // Determinar si debemos reproducir el sonido (solo si el mensaje no es del usuario actual)
      const shouldPlaySound = !isSentByMe;

      if (type === 'group') {
        if (currentChatType === 'group' && receiver === currentChatUserId) {
          if (audio_url) {
            addAudioMessageToChat(sender, audio_url, msgType, null, sender_avatar, _id);
          } else if (file_url && file_type) {
            addFileMessageToChat(sender, file_url, file_type, msgType, null, sender_avatar, _id);
          } else if (message) {
            addMessageToChat(sender, message, msgType, null, sender_avatar, _id);
          }
        } else {
          updateUnreadBadge(receiver);
          if (shouldPlaySound) playNotificationSound();
        }
      } else {
        // Mensaje privado
        if (currentChatType === 'private' && (sender_id === currentChatUserId || receiver === currentChatUserId)) {
          if (audio_url) {
            addAudioMessageToChat(sender, audio_url, msgType, null, sender_avatar, _id);
          } else if (file_url && file_type) {
            addFileMessageToChat(sender, file_url, file_type, msgType, null, sender_avatar, _id);
          } else if (message) {
            addMessageToChat(sender, message, msgType, null, sender_avatar, _id);
          }
        } else {
          const chatId = isSentByMe ? receiver : sender_id;
          updateUnreadBadge(chatId);
          if (shouldPlaySound) playNotificationSound();
        }
      }
    });

    // Escuchar evento "new_group" para agregar el grupo en tiempo real
    socket.on('new_group', (data) => {
      console.log("Nuevo grupo recibido:", data);
      addGroupChatItem(data);
    });

    // Escuchar evento "group_list" para cargar la lista de grupos al conectar
    socket.on('group_list', (data) => {
      if (data.groups) {
        data.groups.forEach(group => addGroupChatItem(group));
      }
    });

    const emojiButton = document.getElementById('emoji-button');
    const emojiPickerContainer = document.getElementById('emoji-picker-container');
    const messageInput = document.getElementById('message-input');
    let isEmojiPickerVisible = false;

    emojiButton.addEventListener('click', () => {
      isEmojiPickerVisible = !isEmojiPickerVisible;
      emojiPickerContainer.style.display = isEmojiPickerVisible ? 'block' : 'none';
    });

    // Cerrar emoji picker si se hace click fuera de él
    document.addEventListener('click', (e) => {
      if (!emojiButton.contains(e.target) &&
        !emojiPickerContainer.contains(e.target)) {
        emojiPickerContainer.style.display = 'none';
        isEmojiPickerVisible = false;
      }
    });

    // Selector de emoji
    document.querySelector('emoji-picker')
      .addEventListener('emoji-click', event => {
        messageInput.value += event.detail.unicode;
        messageInput.focus();
      });

    function addMessageToChat(nombre, contenido, tipo = 'received', timestamp = null, avatar = '') {
      const templateId = tipo === 'sent' ? 'message-template-sent' : 'message-template-received';
      const template = document.getElementById(templateId).content.cloneNode(true);
      if (tipo === 'received') {
        template.querySelector('strong').textContent = nombre;
        template.querySelector('.avatar img').src = avatar;
      }
      const timeString = timestamp ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      template.querySelector('p').textContent = contenido;
      template.querySelector('.message-time').textContent = timeString;
      const messagesContainer = document.querySelector('.messages-container');
      messagesContainer.appendChild(template);
      scrollToBottom(messagesContainer);
    }

    function addAudioMessageToChat(nombre, audioUrl, tipo = 'received', timestamp = null, avatar = '', messageId = null) {
      // Verificar si el mensaje ya ha sido procesado
      if (messageId && processedMessageIds.has(messageId)) {
        return;
      }

      const templateId = tipo === 'sent' ? 'message-template-sent' : 'message-template-received';
      const template = document.getElementById(templateId).content.cloneNode(true);
      if (tipo === 'received') {
        template.querySelector('strong').textContent = nombre;
        template.querySelector('.avatar img').src = avatar;
      }
      const timeString = timestamp ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const audioElement = document.createElement('audio');
      audioElement.src = audioUrl;
      audioElement.controls = true;
      template.querySelector('p').replaceWith(audioElement);
      template.querySelector('.message-time').textContent = timeString;
      const messagesContainer = document.querySelector('.messages-container');
      messagesContainer.appendChild(template);
      scrollToBottom(messagesContainer);

      // Agregar el ID del mensaje a la lista de procesados
      if (messageId) {
        processedMessageIds.add(messageId);
      }
    }

    function loadMessagesWith(contactId) {
      fetch(`/get_messages_with/${contactId}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const messagesContainer = document.querySelector('.messages-container');
            messagesContainer.innerHTML = '';
            data.messages.forEach(message => {
              const msgType = message.sender_id === sessionUserId ? 'sent' : 'received';

              // Manejar diferentes tipos de mensajes
              if (message.audio_url) {
                addAudioMessageToChat(message.sender, message.audio_url, msgType, message.sent_at, message.sender_avatar);
              } else if (message.file_url && message.file_type) {
                // Renderizar mensajes de archivo
                addFileMessageToChat(message.sender, message.file_url, message.file_type, msgType, message.sent_at, message.sender_avatar);
              } else if (message.message) {
                // Mensajes de texto normales
                addMessageToChat(message.sender, message.message, msgType, message.sent_at, message.sender_avatar);
              }
            });

            // Actualizar el avatar y el título del chat
            const contact = data.contact;
            document.getElementById('chat-avatar').src = contact.profile_pic;
            document.getElementById('chat-title').textContent = contact.username;
            document.getElementById('chat-subtitle').textContent = '';
          } else {
            console.error('Error:', data.message);
          }
        })
        .catch(error => console.error('Error:', error));
    }

    function loadGroupMessages(groupId) {
      fetch(`/get_group_messages/${groupId}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const messagesContainer = document.querySelector('.messages-container');
            messagesContainer.innerHTML = '';
            data.messages.forEach(message => {
              const msgType = message.sender_id === sessionUserId ? 'sent' : 'received';

              // Manejar diferentes tipos de mensajes
              if (message.audio_url) {
                addAudioMessageToChat(message.sender, message.audio_url, msgType, message.sent_at, message.sender_avatar);
              } else if (message.file_url && message.file_type) {
                // Renderizar mensajes de archivo
                addFileMessageToChat(message.sender, message.file_url, message.file_type, msgType, message.sent_at, message.sender_avatar);
              } else if (message.message) {
                // Mensajes de texto normales
                addMessageToChat(message.sender, message.message, msgType, message.sent_at, message.sender_avatar);
              }
            });

            // Actualizar el avatar y el título del grupo
            const group = data.group;
            document.getElementById('chat-avatar').src = group.profile_pic || 'https://via.placeholder.com/150?text=Grupo';
            document.getElementById('chat-title').textContent = group.group_name;
            document.getElementById('chat-subtitle').textContent = '';
          } else {
            console.error('Error:', data.message);
          }
        })
        .catch(error => console.error('Error:', error));
    }

    // Función para actualizar el badge de mensajes no leídos en un chat
    function updateUnreadBadge(chatId) {
      const chatItems = document.querySelectorAll('.chat-item');
      chatItems.forEach(item => {
        if (item.dataset.id === chatId) {
          const badge = item.querySelector('.unread-badge');
          let count = parseInt(badge.textContent) || 0;
          badge.textContent = count + 1;
        }
      });
    }

    settingsButton.addEventListener('click', function (event) {
      event.stopPropagation();
      isOpen = !isOpen;
      dropdownMenu.classList.toggle('show');
      this.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0)';
      this.style.transition = 'transform 0.3s ease';
    });

    document.addEventListener('click', function (event) {
      if (!settingsButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
        dropdownMenu.classList.remove('show');
        settingsButton.style.transform = 'rotate(0)';
        isOpen = false;
      }
    });

    function scrollToBottom(container) {
      const scrollHeight = container.scrollHeight;
      container.scrollTo({
        top: scrollHeight,
        behavior: 'smooth'
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      const fileButton = document.getElementById('file-button');
      const fileUploadContainer = document.getElementById('file-upload-container');
      const cancelUploadButton = document.getElementById('cancel-upload');
      const sendFilesButton = document.getElementById('send-files');
      let pond;

      // Inicializar FilePond
      pond = initializeFilePond();
      // Mostrar/ocultar el contenedor de carga de archivos
      fileButton.addEventListener('click', function () {
        fileUploadContainer.style.display = fileUploadContainer.style.display === 'none' ? 'block' : 'none';
      });

      // Cancelar la carga de archivos
      cancelUploadButton.addEventListener('click', function () {
        pond.removeFiles();
        fileUploadContainer.style.display = 'none';
      });

      // Enviar archivos
      sendFilesButton.addEventListener('click', async function () {
        const files = pond.getFiles();
        if (files.length === 0) return;

        // Mostrar indicador de carga
        sendFilesButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        sendFilesButton.disabled = true;

        // Subir archivos a S3
        const fileUrls = await uploadFilesToS3(files);

        // Enviar archivos en el chat
        await sendFiles(fileUrls);

        // Limpiar y ocultar el contenedor de carga
        pond.removeFiles();
        fileUploadContainer.style.display = 'none';

        // Restaurar el botón
        sendFilesButton.innerHTML = 'Enviar';
        sendFilesButton.disabled = false;
      });

      // Cargar la preferencia de notificaciones guardada
      const savedNotificationPreference = localStorage.getItem('notificationsEnabled');
      if (savedNotificationPreference !== null) {
        notificationsEnabled = savedNotificationPreference === 'true';
      }
      const messagesContainer = document.querySelector('.messages-container');
      const scrollButton = document.createElement('button');
      scrollButton.className = 'scroll-bottom-button';
      scrollButton.innerHTML = '<i class="fas fa-arrow-down"></i>';
      scrollButton.style.display = 'none';
      document.querySelector('.chat-main').appendChild(scrollButton);

      messagesContainer.addEventListener('scroll', function () {
        const isNearBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 100;
        scrollButton.style.display = isNearBottom ? 'none' : 'block';
      });

      scrollButton.addEventListener('click', function () {
        scrollToBottom(messagesContainer);
      });

      loadContacts();
      loadGroups();
      getAWSCredentials();
    });

    // Agregar item de contacto a la lista de chats (se asigna data-id)
    function addChatItem(contact) {
      const chatList = document.querySelector('.chat-list');
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-item';
      chatItem.dataset.id = contact._id;
      chatItem.innerHTML = `
        <div class="avatar">
          <img src="${contact.profile_pic}" alt="${contact.username}">
        </div>
        <div class="chat-name">${contact.username}</div>
        <div class="chat-info"><span></span></div>
        <div class="chat-time"></div>
        <div class="unread-badge">0</div>
      `;
      chatItem.addEventListener('click', () => {
        currentChatUserId = contact._id;
        currentChatType = 'private';
        document.getElementById('chat-title').textContent = contact.username;
        document.getElementById('chat-subtitle').textContent = '';
        // Al abrir el chat se resetea el badge
        chatItem.querySelector('.unread-badge').textContent = '0';
        loadMessagesWith(contact._id);
        // Cerrar la barra lateral en dispositivos móviles
        if (window.innerWidth <= 768) {
          chatSidebar.classList.remove('active');
        }
      });
      chatList.appendChild(chatItem);
    }

    // Agregar item de grupo a la lista de chats
    function addGroupChatItem(group) {
      const chatList = document.querySelector('.chat-list');
      // Evitar duplicados
      const exists = [...chatList.children].some(item => item.dataset.id === group._id);
      if (exists) return;
      const chatItem = document.createElement('div');
      chatItem.className = 'chat-item';
      chatItem.dataset.id = group._id;
      chatItem.innerHTML = `
    <div class="avatar">
      <img src="${group.profile_pic}" alt="${group.group_name}">
    </div>
    <div class="chat-name">${group.group_name}</div>
    <div class="chat-info"><span></span></div>
    <div class="chat-time"></div>
    <div class="unread-badge">0</div>
  `;
      chatItem.addEventListener('click', () => {
        currentChatUserId = group._id;
        currentChatType = 'group';
        document.getElementById('chat-title').textContent = group.group_name;
        document.getElementById('chat-subtitle').textContent = '';
        document.getElementById('chat-avatar').src = group.profile_pic;
        chatItem.querySelector('.unread-badge').textContent = '0';
        loadGroupMessages(group._id);
        // Cerrar la barra lateral en dispositivos móviles
        if (window.innerWidth <= 768) {
          chatSidebar.classList.remove('active');
        }
      });
      chatList.appendChild(chatItem);
    }

    // Cargar contactos desde el backend
    function loadContacts() {
      fetch('/get_contacts')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            data.contacts.forEach(contact => {
              addChatItem(contact);
            });
          } else {
            console.error('Error al cargar contactos:', data.message);
          }
        })
        .catch(error => console.error('Error:', error));
    }

    // Cargar grupos desde el backend
    function loadGroups() {
      fetch('/get_groups')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            data.groups.forEach(group => {
              addGroupChatItem(group);
            });
          } else {
            console.error('Error al cargar grupos:', data.message);
          }
        })
        .catch(error => console.error('Error:', error));
    }

    // Modal para agregar contactos
    const addContactButton = document.getElementById('add-contact-button');
    const addContactModal = document.getElementById('add-contact-modal');
    const closeContactModalButton = document.querySelector('#add-contact-modal .close-button');
    const addContactForm = document.getElementById('add-contact-form');

    addContactButton.addEventListener('click', function () {
      addContactModal.style.display = 'block';
    });

    closeContactModalButton.addEventListener('click', function () {
      addContactModal.style.display = 'none';
    });

    window.addEventListener('click', function (event) {
      if (event.target === addContactModal) {
        addContactModal.style.display = 'none';
      }
    });

    addContactForm.addEventListener('submit', function (event) {
      event.preventDefault();
      const contactUsername = document.getElementById('contact-username').value;
      fetch('/add_contact', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          user_id: sessionUserId,
          contact_username: contactUsername
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            alert('Contacto agregado exitosamente');
            addContactModal.style.display = 'none';
            fetch(`/get_user/${contactUsername}`)
              .then(response => response.json())
              .then(userData => {
                if (userData.status === 'success') {
                  addChatItem(userData.user);
                }
              });
          } else {
            alert('Error al agregar contacto: ' + data.message);
          }
        })
        .catch(error => console.error('Error:', error));
    });

    // Modal para crear grupo
    const createGroupButton = document.getElementById('create-group-button');
    const createGroupModal = document.getElementById('create-group-modal');
    const closeGroupModalButton = document.getElementById('close-group-modal');
    const createGroupForm = document.getElementById('create-group-form');

    createGroupButton.addEventListener('click', function () {
      createGroupModal.style.display = 'block';
      loadContactsForGroup();
    });

    closeGroupModalButton.addEventListener('click', function () {
      createGroupModal.style.display = 'none';
    });

    window.addEventListener('click', function (event) {
      if (event.target === createGroupModal) {
        createGroupModal.style.display = 'none';
      }
    });

    // Cargar contactos en el modal de grupo
    function loadContactsForGroup() {
      fetch('/get_contacts')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const membersListDiv = document.getElementById('group-members-list');
            const adminsListDiv = document.getElementById('group-admins-list');
            membersListDiv.innerHTML = '';
            adminsListDiv.innerHTML = '';
            data.contacts.forEach(contact => {
              if (contact._id === sessionUserId) return;
              let memberCheckbox = document.createElement('div');
              memberCheckbox.innerHTML = `<label><input type="checkbox" class="group-member-checkbox" value="${contact._id}"> ${contact.username}</label>`;
              membersListDiv.appendChild(memberCheckbox);

              let adminCheckbox = document.createElement('div');
              adminCheckbox.innerHTML = `<label><input type="checkbox" class="group-admin-checkbox" value="${contact._id}"> ${contact.username}</label>`;
              adminsListDiv.appendChild(adminCheckbox);
            });
          }
        })
        .catch(error => console.error('Error:', error));
    }

    // Envío del formulario para crear grupo
    createGroupForm.addEventListener('submit', function (event) {
      event.preventDefault();
      const groupName = document.getElementById('group-name').value;
      const memberCheckboxes = document.querySelectorAll('.group-member-checkbox');
      const adminCheckboxes = document.querySelectorAll('.group-admin-checkbox');
      let members = [];
      let admins = [];
      memberCheckboxes.forEach(chk => {
        if (chk.checked) {
          members.push(chk.value);
        }
      });
      adminCheckboxes.forEach(chk => {
        if (chk.checked) {
          admins.push(chk.value);
        }
      });
      fetch('/create_group', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          group_name: groupName,
          members: members,
          admins: admins
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            alert('Grupo creado exitosamente');
            createGroupModal.style.display = 'none';
            addGroupChatItem(data.group);
          } else {
            alert('Error al crear grupo: ' + data.message);
          }
        })
        .catch(error => console.error('Error:', error));
    });

    //Configuración de Cloudinary
    const CLOUDINARY_CLOUD_NAME = 'dmyejrbs7';
    const CLOUDINARY_UPLOAD_PRESET = 'apuntes';

    let mediaRecorder;
    let audioChunks = [];
    let audioUrl = null;
    let audioBlob = null;

    function openCloudinaryUploader() {
      cloudinary.openUploadWidget({
        cloudName: CLOUDINARY_CLOUD_NAME,
        uploadPreset: CLOUDINARY_UPLOAD_PRESET,
        sources: ['local', 'url', 'camera'],
        multiple: false,
        cropping: true,
        croppingAspectRatio: 1,
        showSkipCropButton: false,
        maxImageFileSize: 2000000, // 2MB
        maxImageWidth: 1000,
        maxImageHeight: 1000,
        clientAllowedFormats: ["jpg", "jpeg", "png"]
      }, (error, result) => {
        if (!error && result && result.event === "success") {
          const imageUrl = result.info.secure_url;
          fetch('/update_avatar', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ avatar_url: imageUrl })
          })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'success') {
                // Actualizar todas las imágenes de avatar
                document.getElementById('user-avatar-img-nav').src = imageUrl;

                // Verificar si existe el elemento móvil antes de actualizarlo
                const mobileAvatar = document.getElementById('user-avatar-img-mobile');
                if (mobileAvatar) {
                  mobileAvatar.src = imageUrl;
                }
              } else {
                alert('Error al actualizar el avatar: ' + data.message);
              }
            })
            .catch(error => console.error('Error:', error));
        }
      });
    }

    document.getElementById('grabar-audio').addEventListener('click', grabarAudio);

    async function subirAudio(blob) {
      const params = {
        Bucket: S3_BUCKET_NAME,
        Key: 'audios/' + Date.now() + '.webm',
        Body: blob,
        ContentType: 'audio/webm'
      };

      try {
        const data = await s3.upload(params).promise();
        console.log('Audio subido con éxito:', data.Location);
        return data.Location;
      } catch (error) {
        console.error('Error al subir el audio:', error);
        alert('Error al subir el audio. Por favor, revisa la consola para más detalles.');
        return null;
      }
    }

    function grabarAudio() {
      const button = document.getElementById('grabar-audio');

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Tu navegador no soporta la grabación de audio. Por favor, usa un navegador compatible como Chrome o Firefox.');
        return;
      }

      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        button.innerHTML = '<i class="fas fa-microphone"></i>'; // Restaurar el ícono original
        return;
      }

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();
          button.innerHTML = '<i class="fas fa-stop"></i>'; // Cambiar a ícono de detener

          audioChunks = [];
          mediaRecorder.addEventListener("dataavailable", event => {
            audioChunks.push(event.data);
          });

          mediaRecorder.addEventListener("stop", async () => {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const audioUrl = await subirAudio(blob);
            if (audioUrl) {
              const data = {
                sender: sessionUserId,
                receiver: currentChatUserId,
                type: currentChatType,
                audio_url: audioUrl
              };

              // Enviar el mensaje a través de Socket.IO
              socket.emit('send_message', data);

              // NO agregar el mensaje manualmente aquí, ya que llegará a través de Socket.IO

              // Detener todas las pistas del stream para liberar el micrófono
              stream.getTracks().forEach(track => track.stop());
            }
          });
        })
        .catch(error => console.error('Error al grabar audio:', error));
    }

    // Asignar el evento al botón de la barra lateral
    const navAvatarLink = document.getElementById('upload-avatar-link-nav');
    if (navAvatarLink) {
      navAvatarLink.addEventListener('click', openCloudinaryUploader);
    }

    // Asignar el evento al botón móvil
    const mobileAvatarLink = document.getElementById('upload-avatar-link-mobile');
    if (mobileAvatarLink) {
      mobileAvatarLink.addEventListener('click', openCloudinaryUploader);
    }

    const groupSettingsButton = document.getElementById('group-settings-button');
    const updateGroupAvatarModal = document.getElementById('update-group-avatar-modal');
    const closeGroupAvatarModalButton = document.getElementById('close-group-avatar-modal');
    const uploadGroupAvatarButton = document.getElementById('upload-group-avatar-button');

    groupSettingsButton.addEventListener('click', function () {
      updateGroupAvatarModal.style.display = 'block';
    });

    closeGroupAvatarModalButton.addEventListener('click', function () {
      updateGroupAvatarModal.style.display = 'none';
    });

    window.addEventListener('click', function (event) {
      if (event.target === updateGroupAvatarModal) {
        updateGroupAvatarModal.style.display = 'none';
      }
    });

    uploadGroupAvatarButton.addEventListener('click', function () {
      const groupId = currentChatUserId; // Asumiendo que currentChatUserId es el ID del grupo actual
      updateGroupAvatar(groupId);
    });

    function updateGroupAvatar(groupId) {
      cloudinary.openUploadWidget({
        cloudName: CLOUDINARY_CLOUD_NAME,
        uploadPreset: CLOUDINARY_UPLOAD_PRESET,
        sources: ['local', 'url', 'camera'],
        multiple: false,
        cropping: true,
        croppingAspectRatio: 1,
        showSkipCropButton: false,
        maxImageFileSize: 2000000, // 2MB
        maxImageWidth: 1000,
        maxImageHeight: 1000,
        clientAllowedFormats: ["jpg", "jpeg", "png"]
      }, (error, result) => {
        if (!error && result && result.event === "success") {
          const imageUrl = result.info.secure_url;
          fetch('/update_group_avatar', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ group_id: groupId, avatar_url: imageUrl })
          })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'success') {
                document.getElementById('chat-avatar').src = imageUrl;
                document.getElementById('group-avatar-img').src = imageUrl;
                updateGroupAvatarModal.style.display = 'none';
              } else {
                alert('Error al actualizar el avatar del grupo: ' + data.message);
              }
            })
            .catch(error => console.error('Error:', error));
        }
      });
    }

    // Función para obtener las credenciales de AWS
    function getAWSCredentials() {
      fetch('/get_aws_credentials')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            AWS.config.update({
              accessKeyId: data.access_key,
              secretAccessKey: data.secret_key,
              region: 'us-east-2' // Ejemplo: 'us-east-1'
            });
            S3_BUCKET_NAME = data.s3_bucket;
            s3 = new AWS.S3(); // Inicializar la variable s3
            console.log('Credenciales de AWS obtenidas con éxito');
          } else {
            console.error('Error al obtener credenciales de AWS:', data.message);
          }
        })
        .catch(error => console.error('Error:', error));
    }

    // Función para inicializar FilePond
    // Función para inicializar FilePond con más tipos de archivos permitidos
    function initializeFilePond() {
      // Registrar plugins de FilePond
      FilePond.registerPlugin(
        FilePondPluginFileEncode,
        FilePondPluginFileValidateType,
        FilePondPluginImagePreview
      );

      // Crear instancia de FilePond
      const pond = FilePond.create(document.querySelector('.filepond'), {
        allowMultiple: true,
        maxFiles: 5,
        // Ampliar los tipos de archivos aceptados
        acceptedFileTypes: [
          'image/*',                                                  // Imágenes
          'application/pdf',                                          // PDF
          'application/msword',                                       // DOC
          'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // DOCX
          'application/vnd.ms-powerpoint',                            // PPT
          'application/vnd.openxmlformats-officedocument.presentationml.presentation', // PPTX
          'application/vnd.ms-excel',                                 // XLS
          'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // XLSX
          'text/plain',                                               // TXT
          'text/html',                                                // HTML
          'text/css',                                                 // CSS
          'text/javascript',                                          // JS
          'application/json',                                         // JSON
          'application/xml',                                          // XML
          'application/zip',                                          // ZIP
          'application/x-rar-compressed',                             // RAR
          'application/x-7z-compressed',                              // 7Z
          'application/x-msdownload',                                 // EXE
          'application/x-sh',                                         // SH
          'application/x-python',                                     // Python
          'application/java-archive',                                 // JAR
          'application/octet-stream'                                  // Binarios genéricos
        ],
        labelIdle: 'Arrastra y suelta archivos o <span class="filepond--label-action">Examinar</span>',
        labelFileTypeNotAllowed: 'Tipo de archivo no válido',
        fileValidateTypeLabelExpectedTypes: 'Se esperan archivos de tipo {allTypes}',
        labelMaxFileSizeExceeded: 'El archivo es demasiado grande',
        labelMaxFileSize: 'El tamaño máximo de archivo es {filesize}',
        maxFileSize: '20MB' // Aumentar el tamaño máximo para archivos más grandes
      });

      return pond;
    }

    // Función para subir un archivo a AWS S3
    async function uploadFileToS3(file) {
      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch('/upload_file', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        if (data.status === 'success') {
          return data.file_url;
        } else {
          console.error('Error al subir archivo:', data.message);
          return null;
        }
      } catch (error) {
        console.error('Error al subir archivo:', error);
        return null;
      }
    }

    // Función para subir múltiples archivos a S3
    async function uploadFilesToS3(files) {
      const uploadPromises = files.map(file => {
        return uploadFileToS3(file.file);
      });

      try {
        const fileUrls = await Promise.all(uploadPromises);
        return fileUrls.filter(url => url !== null);
      } catch (error) {
        console.error('Error al subir archivos:', error);
        return [];
      }
    }

    // Función para enviar archivos en el chat
    async function sendFiles(fileUrls) {
      if (fileUrls.length === 0 || !currentChatUserId) return;

      for (const fileUrl of fileUrls) {
        const fileType = getFileTypeFromUrl(fileUrl);
        const data = {
          sender: sessionUserId,
          sender_id: sessionUserId,
          receiver: currentChatUserId,
          type: currentChatType,
          file_url: fileUrl,
          file_type: fileType
        };

        // Enviar el mensaje a través de Socket.IO
        socket.emit('send_message', data);
      }
    }

    // Función mejorada para determinar el tipo de archivo basado en la URL
    function getFileTypeFromUrl(url) {
      const extension = url.split('.').pop().toLowerCase().split('?')[0];

      const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg', 'ico'];
      const documentExtensions = [
        'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'rtf', 'odt', 'ods', 'odp'
      ];
      const codeExtensions = [
        'html', 'css', 'js', 'ts', 'jsx', 'tsx', 'json', 'xml', 'yaml', 'yml',
        'py', 'java', 'c', 'cpp', 'cs', 'php', 'rb', 'go', 'swift', 'kt', 'rs'
      ];
      const archiveExtensions = ['zip', 'rar', '7z', 'tar', 'gz', 'bz2', 'xz'];
      const executableExtensions = ['exe', 'msi', 'bin', 'sh', 'bat', 'cmd', 'app', 'jar', 'apk'];

      if (imageExtensions.includes(extension)) return 'image';
      if (documentExtensions.includes(extension)) return 'document';
      if (codeExtensions.includes(extension)) return 'code';
      if (archiveExtensions.includes(extension)) return 'archive';
      if (executableExtensions.includes(extension)) return 'executable';

      return 'other';
    }

    function addFileMessageToChat(sender, fileUrl, fileType, tipo = 'received', timestamp = null, avatar = '', messageId = null) {
      // Verificar si el mensaje ya ha sido procesado
      if (messageId && processedMessageIds.has(messageId)) {
        return;
      }

      const templateId = tipo === 'sent' ? 'message-template-sent' : 'message-template-received';
      const template = document.getElementById(templateId).content.cloneNode(true);

      if (tipo === 'received') {
        template.querySelector('strong').textContent = sender;
        template.querySelector('.avatar img').src = avatar || '/placeholder.svg';
      }

      const timeString = timestamp
        ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      // Crear el elemento según el tipo de archivo
      let fileElement;

      if (fileType === 'image') {
        fileElement = document.createElement('a');
        fileElement.href = fileUrl;
        fileElement.setAttribute('data-fancybox', 'gallery');
        fileElement.className = 'file-message image-message';

        const img = document.createElement('img');
        img.src = fileUrl;
        img.alt = 'Imagen compartida';
        img.style.maxWidth = '200px';
        img.style.maxHeight = '200px';
        img.style.borderRadius = '8px';

        fileElement.appendChild(img);
      } else {
        fileElement = document.createElement('a');
        fileElement.href = fileUrl;
        fileElement.target = '_blank';
        fileElement.className = 'file-message';
        fileElement.setAttribute('data-type', fileType); // Para aplicar estilos específicos

        const icon = document.createElement('i');

        // Asignar el icono correcto según el tipo de archivo
        switch (fileType) {
          case 'document':
            icon.className = 'fas fa-file-alt';
            break;
          case 'code':
            icon.className = 'fas fa-file-code';
            break;
          case 'archive':
            icon.className = 'fas fa-file-archive';
            break;
          case 'executable':
            icon.className = 'fas fa-file-code';
            break;
          default:
            icon.className = 'fas fa-file';
        }

        // Extraer solo el nombre real del archivo sin el ID
        const fullPath = decodeURIComponent(fileUrl.split('/').pop().split('?')[0]);

        // Intentar extraer solo el nombre del archivo sin el ID
        let fileName;

        // Buscar patrones comunes como "ID_nombrearchivo.ext"
        const fileNameMatch = fullPath.match(/[a-f0-9]+_(.+)$/);
        if (fileNameMatch && fileNameMatch[1]) {
          fileName = fileNameMatch[1]; // Usar solo la parte después del ID y guion bajo
        } else {
          // Si no se encuentra el patrón, usar el nombre completo
          fileName = fullPath;
        }

        const fileNameElement = document.createElement('span');
        fileNameElement.className = 'file-name';

        // Truncar nombres largos (más de 20 caracteres)
        if (fileName.length > 20) {
          const extension = fileName.lastIndexOf('.') > -1 ? fileName.substring(fileName.lastIndexOf('.')) : '';
          const baseName = fileName.substring(0, fileName.lastIndexOf('.') > -1 ? fileName.lastIndexOf('.') : fileName.length);

          if (baseName.length > 16) {
            // Truncar el nombre base y mantener la extensión
            fileNameElement.textContent = baseName.substring(0, 16) + '...' + extension;
            // Agregar el nombre completo como tooltip
            fileNameElement.title = fileName;
          } else {
            fileNameElement.textContent = fileName;
          }
        } else {
          fileNameElement.textContent = fileName;
        }

        fileElement.appendChild(icon);
        fileElement.appendChild(document.createTextNode(' '));
        fileElement.appendChild(fileNameElement);

        // Aplicar estilos según el tipo de mensaje
        fileElement.style.display = 'flex';
        fileElement.style.alignItems = 'center';
        fileElement.style.gap = '8px';
        fileElement.style.color = '#e0e0e0';
        fileElement.style.textDecoration = 'none';
        fileElement.style.padding = '8px';
        fileElement.style.backgroundColor = tipo === 'sent' ? '#056162' : '#2a2a2a';
        fileElement.style.borderRadius = '8px';
        fileElement.style.maxWidth = '100%';

        // Estilos para el nombre del archivo
        fileNameElement.style.overflow = 'hidden';
        fileNameElement.style.textOverflow = 'ellipsis';
        fileNameElement.style.whiteSpace = 'nowrap';
        fileNameElement.style.maxWidth = 'calc(100% - 30px)';
      }

      template.querySelector('p').replaceWith(fileElement);
      template.querySelector('.message-time').textContent = timeString;

      const messagesContainer = document.querySelector('.messages-container');
      messagesContainer.appendChild(template);
      scrollToBottom(messagesContainer);

      // Inicializar Fancybox para las imágenes
      if (fileType === 'image') {
        $('[data-fancybox="gallery"]').fancybox({
          buttons: ['zoom', 'download', 'close']
        });
      }

      // Agregar el ID del mensaje a la lista de procesados
      if (messageId) {
        processedMessageIds.add(messageId);
      }
    }

  </script>
  <audio id="notification-sound" preload="auto">
    <source src="../static/notifications/notification.mp3" type="audio/mpeg">
  </audio>
</body>

</html>

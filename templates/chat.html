<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <title>chatpy.io</title>
    <link rel="stylesheet" href="../static/styles.css">
    <link rel="icon" type="image/png" sizes="32x32" href="../static/images/favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="../static/images/favicon.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
</head>

<body>
    <div class="chat-container">
        <nav class="nav-sidebar">
            <div class="nav-top">
                <div class="nav-icon action-button">
                    <i class="fas fa-comment"></i>
                </div>
                <div class="unread-total">6</div>
            </div>
            <div class="nav-bottom">
                <div class="dropdown">
                    <div class="nav-icon action-button cursor-pointer" id="settings-button">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div id="dropdown-menu" class="dropdown-menu">
                        <a href="/logout">
                            <i class="fas fa-sign-out-alt"></i>
                            Cerrar sesiÃ³n
                        </a>
                    </div>
                </div>
                <div class="user-avatar">
                    <img src="https://media-mia3-1.cdn.whatsapp.net/v/t61.24694-24/461338513_543649241643596_1140871026957553677_n.jpg?ccb=11-4&oh=01_Q5AaIDUIt2ARpZvXBf1kgVemO0mwXtykj8ZxR0YDgFMIlL_S&oe=67AC9A42&_nc_sid=5e03e0&_nc_cat=108"
                        alt="TÃº">
                </div>
            </div>
        </nav>

        <aside class="chat-sidebar">
            <div class="sidebar-header">
                <h1>Chats</h1>
                <div class="header-icons">
                    <button class="action-button" id="add-contact-button">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    <button class="action-button">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>

            <div class="search-container">
                <i class="search-icon fas fa-search"></i>
                <input type="text" class="search-input" placeholder="Buscar">
            </div>

            <div class="filter-buttons">
                <button class="filter-button">Todos</button>
                <button class="filter-button">No leÃ­dos</button>
            </div>

            <div class="chat-list">
                <div class="chat-item">
                    <div class="avatar">
                        <img src="https://media-mia3-1.cdn.whatsapp.net/v/t61.24694-24/473400983_937214201872149_888653449431714886_n.jpg?ccb=11-4&oh=01_Q5AaIKJDHgQXNi1AsuEgYc9hfxU4NxtyO4wBJG57nyDb_E33&oe=67AAC1D7&_nc_sid=5e03e0&_nc_cat=111"
                            alt="Grupo">
                    </div>
                    <div class="chat-name">Sistemas Distribuidos</div>
                    <div class="chat-info"><span>TÃº: </span>Este es mi primer men...</div>
                    <div class="chat-time">7:30 p.m.</div>
                    <div class="unread-badge">2</div>
                </div>
            </div>
        </aside>

        <main class="chat-main">
            <header class="chat-header">
                <div class="header-left">
                    <div class="avatar">
                        <img src="https://media-mia3-1.cdn.whatsapp.net/v/t61.24694-24/473400983_937214201872149_888653449431714886_n.jpg?ccb=11-4&oh=01_Q5AaIKJDHgQXNi1AsuEgYc9hfxU4NxtyO4wBJG57nyDb_E33&oe=67AAC1D7&_nc_sid=5e03e0&_nc_cat=111"
                            alt="Grupo">
                    </div>
                    <div>
                        <h2>Sistemas Distribuidos</h2>
                        <div style="color: #8f8f8f">Josue, Robert, TÃº...</div>
                    </div>
                </div>
                <div class="header-right">
                    <button class="action-button">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="action-button">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </header>

            <div class="messages-container">
                <div class="message-group josue">
                    <div class="avatar">
                        <img src="https://images.pexels.com/photos/5054346/pexels-photo-5054346.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
                            alt="Josue">
                    </div>
                    <div class="message received">
                        <strong>Josue</strong>
                        <p>Este es el primer mensaje de Josue ðŸš€</p>
                        <div class="message-time">7:30 p.m.</div>
                    </div>
                </div>

                <div class="message-group josue">
                    <div class="avatar">
                        <img src="https://images.pexels.com/photos/5054346/pexels-photo-5054346.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
                            alt="Josue">
                    </div>
                    <div class="message received">
                        <strong>Josue</strong>
                        <p>Este es el segundo mensaje de Josue ðŸš€</p>
                        <div class="message-time">7:31 p.m.</div>
                    </div>
                </div>

                <div class="message-group robert">
                    <div class="avatar">
                        <img src="https://images.pexels.com/photos/4792716/pexels-photo-4792716.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
                            alt="Robert">
                    </div>
                    <div class="message received">
                        <strong>Robert</strong>
                        <p>Este es el primer mensaje de Robert âœ¨</p>
                        <div class="message-time">7:33 p.m.</div>
                    </div>
                </div>

                <div class="message-group robert">
                    <div class="avatar">
                        <img src="https://images.pexels.com/photos/4792716/pexels-photo-4792716.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2"
                            alt="Robert">
                    </div>
                    <div class="message received">
                        <strong>Robert</strong>
                        <p>Este es el segundo mensaje de Robert ðŸ”¥</p>
                        <div class="message-time">8:00 p.m.</div>
                    </div>
                </div>

                <div class="message sent">
                    <p>Este es mi primer mensaje de prueba â˜•</p>
                    <div class="message-time">7:00 a.m.</div>
                </div>
            </div>

            <div class="message-input-container">
                <button class="action-button">
                    <i class="fas fa-paperclip"></i>
                </button>
                <button class="action-button" id="emoji-button">
                    <i class="fas fa-smile"></i>
                </button>
                <div class="message-input-wrapper">
                    <input type="text" class="message-input" id="message-input" placeholder="Escribe un mensaje">
                </div>
                <button class="action-button" id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button class="action-button" id="mic-button">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </main>
    </div>

    <!-- Modal para agregar contactos -->
    <div id="add-contact-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Agregar Contacto</h2>
            <form id="add-contact-form">
                <input type="text" id="contact-username" placeholder="Nombre de usuario" required>
                <button type="submit">Agregar</button>
            </form>
        </div>
    </div>

    <template id="message-template-sent">
        <div class="message sent">
            <p></p>
            <div class="message-time"></div>
        </div>
    </template>

    <template id="message-template-received">
        <div class="message-group">
            <div class="avatar"></div>
            <div class="message received">
                <strong></strong>
                <p></p>
                <div class="message-time"></div>
            </div>
        </div>
    </template>

    <script>
        // Obtenemos el ID del usuario de la sesiÃ³n
        const sessionUserId = "{{ session['user_id'] }}";

        const settingsButton = document.getElementById('settings-button');
        const dropdownMenu = document.getElementById('dropdown-menu');
        let isOpen = false;

        document.getElementById('send-button').addEventListener('click', function () {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value;
            if (message.trim() !== '') {
                fetch('/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sender: sessionUserId,
                        receiver: 'receiver_id', // Reemplazar con el ID del receptor
                        type: 'private', // O 'group' si es un chat grupal
                        message: message
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            messageInput.value = '';
                            addMessageToChat(sessionUserId, message, 'sent');
                        } else {
                            console.error('Error:', data.message);
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        });

        document.getElementById('emoji-button').addEventListener('click', function () {
            const messageInput = document.getElementById('message-input');
            messageInput.value += 'ðŸ˜Š';
        });

        function addMessageToChat(nombre, contenido, tipo = 'received', timestamp = null) {
            const templateId = tipo === 'sent' ? 'message-template-sent' : 'message-template-received';
            const template = document.getElementById(templateId).content.cloneNode(true);
            if (tipo === 'received') {
                template.querySelector('strong').textContent = nombre;
            }
            const timeString = timestamp ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            template.querySelector('p').textContent = contenido;
            template.querySelector('.message-time').textContent = timeString;
            const messagesContainer = document.querySelector('.messages-container');
            messagesContainer.appendChild(template);
            scrollToBottom(messagesContainer);
        }

        settingsButton.addEventListener('click', function(event) {
            event.stopPropagation();
            isOpen = !isOpen;
            dropdownMenu.classList.toggle('show');
            
            this.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0)';
            this.style.transition = 'transform 0.3s ease';
        });

        document.addEventListener('click', function(event) {
            if (!settingsButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.remove('show');
                settingsButton.style.transform = 'rotate(0)';
                isOpen = false;
            }
        });

        function scrollToBottom(container) {
            const scrollHeight = container.scrollHeight;
            container.scrollTo({
                top: scrollHeight,
                behavior: 'smooth'
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const messagesContainer = document.querySelector('.messages-container');
            const scrollButton = document.createElement('button');
            scrollButton.className = 'scroll-bottom-button';
            scrollButton.innerHTML = '<i class="fas fa-arrow-down"></i>';
            scrollButton.style.display = 'none';
            document.querySelector('.chat-main').appendChild(scrollButton);

            messagesContainer.addEventListener('scroll', function() {
                const isNearBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 100;
                scrollButton.style.display = isNearBottom ? 'none' : 'block';
            });

            scrollButton.addEventListener('click', function() {
                scrollToBottom(messagesContainer);
            });

            // Cargar mensajes al cargar la pÃ¡gina
            fetch('/get_messages')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        data.messages.forEach(message => {
                            const tipo = message.sender === sessionUserId ? 'sent' : 'received';
                            addMessageToChat(message.sender, message.message, tipo, message.sent_at);
                        });
                    } else {
                        console.error('Error:', data.message);
                    }
                })
                .catch(error => console.error('Error:', error));

            loadContacts();
        });

        const style = document.createElement('style');
        style.textContent = `
            .scroll-bottom-button {
                position: absolute;
                bottom: 80px;
                right: 20px;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-color: #056162;
                border: none;
                color: white;
                cursor: pointer;
                display: none;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
                z-index: 100;
                transition: all 0.3s ease;
            }

            .scroll-bottom-button:hover {
                background-color: #0a7373;
                transform: translateY(-2px);
            }
        `;
        document.head.appendChild(style);

        // Modal para agregar contactos
        const addContactButton = document.getElementById('add-contact-button');
        const addContactModal = document.getElementById('add-contact-modal');
        const closeButton = document.querySelector('.close-button');
        const addContactForm = document.getElementById('add-contact-form');

        addContactButton.addEventListener('click', function() {
            addContactModal.style.display = 'block';
        });

        closeButton.addEventListener('click', function() {
            addContactModal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target === addContactModal) {
                addContactModal.style.display = 'none';
            }
        });

        function addChatItem(contact) {
            const chatList = document.querySelector('.chat-list');
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.innerHTML = `
                <div class="avatar">
                    <img src="${contact.profile_pic}" alt="${contact.username}">
                </div>
                <div class="chat-name">${contact.username}</div>
                <div class="chat-info"><span></span></div>
                <div class="chat-time"></div>
                <div class="unread-badge">0</div>
            `;
            chatList.appendChild(chatItem);
        }

        function loadContacts() {
            fetch('/get_contacts')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        data.contacts.forEach(contact => {
                            addChatItem(contact);
                        });
                    } else {
                        console.error('Error al cargar contactos:', data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        addContactForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const contactUsername = document.getElementById('contact-username').value;
            fetch('/add_contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: sessionUserId,
                    contact_username: contactUsername
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Contacto agregado exitosamente');
                        addContactModal.style.display = 'none';
                        fetch(`/get_user/${contactUsername}`)
                            .then(response => response.json())
                            .then(userData => {
                                if (userData.status === 'success') {
                                    addChatItem(userData.user);
                                }
                            });
                    } else {
                        alert('Error al agregar contacto: ' + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    </script>
</body>

</html>